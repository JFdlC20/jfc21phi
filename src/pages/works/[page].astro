---
// Layout
import Layout from "../../layouts/Layout.astro";

// Styling
import "../../styles/markdown.css";

// Components
import Container from "../../components/elements/Container.astro";
import Heading from "../../components/elements/Heading.astro";
import Text from "../../components/elements/Text.astro";
import ImageContainer from "../../components/elements/ImageContainer.astro";
import Link from "../../components/elements/Link.astro";

// Routing
import type { GetStaticPaths } from "astro";
import { render } from "astro:content";
import { getCollection } from "astro:content";

export const getStaticPaths = (async () => {
    // Asegúrate de que la colección se llama "works"
    const works = await getCollection("works", ({data}) => !data.isDraft)
    return works.map((work) => ({
        params: {
            page: work.data.slug,
        },
        props: {
            work,
        }
    }));
}) satisfies GetStaticPaths;

// props
const { work } = Astro.props;
const { Content } = await render(work);

// 1. DESESTRUCTURAMOS LOS NUEVOS CAMPOS DE VÍDEO
const { 
    title, 
    client, 
    category, 
    services, 
    year, 
    description, 
    featuredImage, 
    imageTwo, 
    videoTwo, // <--- Nuevo campo
    imageThree, 
    imageFour, 
    videoFour, // <--- Nuevo campo
    liveSite 
} = work.data;

const details = [
    { heading: "Cliente", text: `${client}` },
    { heading: "Categoría", text: `${category}` },
    { heading: "Servicios", text: `${services}` },
    { heading: "Año", text: `${year}` }
]

// 2. FUNCIÓN PARA DETECTAR YOUTUBE (Igual que en Work.astro)
const getYouTubeId = (url) => {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

const videoTwoID = getYouTubeId(videoTwo);
const videoFourID = getYouTubeId(videoFour);
---

<Layout title={`Proyecto - ${title}`}>
    <Container variant={'xl'} aria-label="Work Details" class="items-center">
        <Heading tagName="h1" tagSize="h1" class="text-center">{title}</Heading>
        
        <div class="w-full md:h-[600px] h-[300px]">
            <ImageContainer src={featuredImage} alt={title} />
        </div>

        <div class="flex flex-col gap-7 md:grid md:grid-cols-4">
            {
                details.map((detail) => (
                    <div class="text-center">
                        <Heading tagName="h2" tagSize="h4" class="mb-2">{detail.heading}</Heading>
                        <Text variant={'sm'} class="text-base-900">{detail.text}</Text>
                    </div>
                ))
            }
        </div>

        <Link variant={'button'} href={liveSite}>Ver Proyecto Online</Link>
        
        <div class="md:max-w-3xl text-base-900">
            <Text variant={'xl'}>{description}</Text>
        </div>

        <div class="flex md:flex-row flex-col gap-7 w-full">
            <div class="flex-1 w-full">
                {
                    videoTwoID ? (
                        <iframe 
                            src={`https://www.youtube.com/embed/${videoTwoID}`}
                            title="Vídeo del proyecto"
                            class="w-full h-full min-h-[300px] aspect-video object-cover rounded-lg"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                        ></iframe>
                    ) : (
                        /* Si no hay vídeo, intenta mostrar la imagen (si existe) */
                        imageTwo && <ImageContainer src={imageTwo} alt={title} />
                    )
                }
            </div>
            <div class="flex-1 w-full">
                { imageThree && <ImageContainer src={imageThree} alt={title} /> }
            </div>
        </div>

        <article class="markdown-content md:max-w-3xl flex flex-col gap-4">
            <Content />
        </article>

        <div class="w-full md:h-[600px] h-[300px]">
            {
                videoFourID ? (
                    <iframe 
                        src={`https://www.youtube.com/embed/${videoFourID}`}
                        title="Vídeo final del proyecto"
                        class="w-full h-full object-cover rounded-lg"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                    ></iframe>
                ) : (
                    imageFour && <ImageContainer src={imageFour} alt={title} />
                )
            }
        </div>

        <Link variant={'button'} href="/works">Ver todos los trabajos</Link>
    </Container>
</Layout>